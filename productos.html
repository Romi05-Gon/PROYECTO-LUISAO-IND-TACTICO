
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Productos - Panel</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="sidebar">
    <h2>Luisao Panel</h2>
    <div class="menu">
      <a href="index.html">Dashboard</a>
      <a href="productos.html">Productos</a>
      <a href="ventas.html">Ventas</a>
      <a href="clientes.html">Clientes</a>
      <a href="proveedores.html">Proveedores</a>
      <a href="usuarios.html">Usuarios</a>
      <a href="pagos.html">Pagos</a>
      <a href="movimientos-caja.html">Movimientos Caja</a>
      <a href="cierres-caja.html">Cierres Caja</a>
    </div>
  </div>

  <div class="content">
    <h1>Productos</h1>

    <div class="card">
      <div class="header-actions">
        <button class="btn btn-primary" id="btnNuevo">+ Nuevo Producto</button>
        <input id="search" placeholder="Buscar..." />
      </div>

      <table class="table" id="tabla">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Descripción</th>
            <th>Precio</th>
            <th>Stock</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Modal -->
  <div id="modalForm" class="modal hidden">
    <div class="dialog">
      <h3 id="modalTitle">Nuevo Producto</h3>

      <div class="form-row">
        <label>Nombre</label>
        <input id="nombre">
      </div>

      <div class="form-row">
        <label>Descripción</label>
        <input id="descripcion">
      </div>

      <div class="form-row">
        <label>Precio</label>
        <input id="precio" type="number" step="0.01">
      </div>

      <div class="form-row">
        <label>Stock</label>
        <input id="stock" type="number">
      </div>

      <div style="text-align:right; margin-top:12px;">
        <button class="btn" onclick="hideModal('modalForm')">Cancelar</button>
        <button class="btn btn-primary" id="saveBtn">Guardar</button>
      </div>
    </div>
  </div>

  <script src="common.js"></script>

  <script>
    const resource = "/api/productos";

    document.addEventListener("DOMContentLoaded", () => {

      const tablaBody = document.querySelector("#tabla tbody");
      const btnNuevo = document.getElementById("btnNuevo");
      const saveBtn = document.getElementById("saveBtn");
      const modalTitle = document.getElementById("modalTitle");

      let editingId = null;

      async function loadAll() {
        try {
          const data = await apiFetch(resource);
          renderRows(data);
        } catch (e) {
          alert("Error cargando productos: " + e.message);
        }
      }

      function renderRows(items) {
        tablaBody.innerHTML = "";

        items.forEach(item => {
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${item.id_producto}</td>
            <td>${item.nombre}</td>
            <td>${item.descripcion}</td>
            <td>${item.precio}</td>
            <td>${item.stock}</td>
            <td>
              <button class="btn" onclick="onEdit(${item.id_producto})">Editar</button>
              <button class="btn btn-danger" onclick="onDelete(${item.id_producto})">Eliminar</button>
            </td>
          `;
          tablaBody.appendChild(tr);
        });
      }

      window.onEdit = async function(id) {
        try {
          const data = await apiFetch(resource + "/" + id);
          editingId = id;

          modalTitle.innerText = "Editar Producto";
          document.getElementById("nombre").value = data.nombre;
          document.getElementById("descripcion").value = data.descripcion;
          document.getElementById("precio").value = data.precio;
          document.getElementById("stock").value = data.stock;

          showModal("modalForm");

        } catch (e) {
          alert("Error: " + e.message);
        }
      }

      window.onDelete = async function(id) {
        if (!confirm("¿Eliminar producto?")) return;

        try {
          await apiFetch(resource + "/" + id, { method: "DELETE" });
          loadAll();
        } catch (e) {
          alert("Error eliminando producto: " + e.message);
        }
      }

      btnNuevo.addEventListener("click", () => {
        editingId = null;

        modalTitle.innerText = "Nuevo Producto";
        document.getElementById("nombre").value = "";
        document.getElementById("descripcion").value = "";
        document.getElementById("precio").value = "";
        document.getElementById("stock").value = "";

        showModal("modalForm");
      });

      saveBtn.addEventListener("click", async () => {
        const payload = {
          nombre: document.getElementById("nombre").value.trim(),
          descripcion: document.getElementById("descripcion").value.trim(),
          precio: document.getElementById("precio").value.trim(),
          stock: document.getElementById("stock").value.trim()
        };

        try {
          if (editingId)
            await apiFetch(resource + "/" + editingId, {
              method: "PUT",
              body: JSON.stringify(payload)
            });
          else
            await apiFetch(resource, {
              method: "POST",
              body: JSON.stringify(payload)
            });

          hideModal("modalForm");
          loadAll();

        } catch (e) {
          alert("Error guardando: " + e.message);
        }
      });

      loadAll();
    });
  </script>

</body>
</html>